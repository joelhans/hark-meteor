FeedParser = Meteor.require 'feedparser'
request    = Meteor.require 'request'
Future     = Meteor.require('fibers/future')
Fiber      = Meteor.require 'fibers'

handleError = (e) ->
  console.log e
  throw new Meteor.Error 500, 'Whoops!'

feeds = new Meteor.Collection 'feeds'

addFeed = (userId, url) ->
  return (meta) ->
    Fiber () ->
      feeds.insert {
        userId : userId
        title  : meta.title
        url    : url
      }, (err, feedId) ->
        if feedId
          console.log 'Feed added:',meta.title
    .run()

Meteor.startup () ->
  Meteor.methods
   
    test: (url) ->
      fut = new Future()

      console.log this.userId

      request(url)
        .pipe(new FeedParser())
        .on 'error', (err) ->
          fut.return err
        .on 'meta', addFeed(Meteor.userId(), url)

      result = fut.wait()

      if result.toString().indexOf('Error') is -1
        return 'Win!'
      else
        throw new Meteor.Error 500, 'Fail.'
     
